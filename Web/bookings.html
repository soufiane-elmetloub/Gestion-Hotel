<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookings - Smart Hotel</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts - Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Shared Layout Styles -->
    <link href="assets/layout.css" rel="stylesheet">
    <style>
        :root { --primary-color:#4e73df; --secondary-color:#1cc88a; --danger-color:#e74a3b; --warning-color:#f6c23e; --info-color:#36b9cc; --light-color:#f8f9fc; --dark-color:#5a5c69; }
        body { font-family:'Cairo',sans-serif; background-color:var(--light-color); min-height:100vh; }
        .navbar { background:linear-gradient(135deg, var(--primary-color) 0%, #2e59d9 100%); box-shadow:0 2px 10px rgba(0,0,0,.1); }
        .navbar .search-center { position:absolute; left:50%; transform:translateX(-50%); width:min(640px, calc(100% - 360px)); display:flex; align-items:center; gap:8px; }
        .navbar .container-fluid { position:relative; }
        .navbar .search-center .search-box { position:relative; width:100%; }
        .navbar .search-center .search-box input { width:100%; height:38px; border-radius:9999px; border:none; outline:none; padding:0 140px 0 44px; background:rgba(255,255,255,.9); color:#1b1e23; box-shadow: inset 0 0 0 1px rgba(255,255,255,.65), 0 4px 10px rgba(0,0,0,.12); }
        .navbar .search-center .search-box .icon-left, .navbar .search-center .search-box .icon-right { position:absolute; top:50%; transform:translateY(-50%); color:#6b7280; }
        .navbar .search-center .search-box .icon-left { left:14px; }
        .navbar .search-center .search-box .icon-right { right:12px; }
        /* Embedded payment filter inside search box */
        .navbar .search-center .search-box .search-select {
            position: absolute;
            top: 50%;
            right: 44px; /* before the sliders icon */
            transform: translateY(-50%);
            height: 28px;
            padding: 0 8px;
            border-radius: 9999px;
            border: 1px solid #e5e7eb;
            background: rgba(255,255,255,0.95);
            color: #1b1e23;
            font-size: 0.85rem;
            outline: none;
        }
        @media (max-width:576px){ .navbar .search-center{ width:75%; } .navbar .search-center .search-box input{ height:34px; } }
        /* Sidebar */
        .sidebar { position:fixed; top:0; left:0; height:100vh; width:260px; background:linear-gradient(180deg, #2e59d9 0%, var(--primary-color) 65%); color:#fff; box-shadow:4px 0 18px rgba(0,0,0,.12); z-index:1041; padding-top:0; overflow-y:auto; border-top-right-radius:16px; border-bottom-right-radius:16px; transition:width .25s ease; }
        body.sidebar-collapsed .sidebar { width:80px; }
        body.sidebar-collapsed .content-wrapper { margin-left:80px; }
        @media (min-width:992px){ .navbar{ padding-left:260px; } body.sidebar-collapsed .navbar{ padding-left:80px; } }
        body.sidebar-collapsed .sidebar .brand-name { display:none; }
        body.sidebar-collapsed .sidebar .menu a { justify-content:center; }
        body.sidebar-collapsed .sidebar .menu a .label { display:none; }
        body.sidebar-collapsed .sidebar .menu a .icon { margin-right:0; }
        body.sidebar-collapsed .sidebar-header { justify-content:center; }
        body.sidebar-collapsed .sidebar-header .brand-logo { height:28px; }
        @media (max-width:991.98px){ body.sidebar-collapsed .sidebar{ width:260px; } body.sidebar-collapsed .content-wrapper{ margin-left:0; } }
        .sidebar-header { display:flex; align-items:center; gap:10px; padding:.2rem .9rem .65rem; margin-bottom:.1rem; border-bottom:1px dashed rgba(255,255,255,.25); position:sticky; top:0; z-index:1; background:linear-gradient(180deg, #2e59d9 0%, rgba(46,89,217,.92) 70%); }
        .brand-logo { height:42px; width:auto; object-fit:contain; filter:brightness(0) invert(1); }
        .brand-name { font-weight:700; font-size:1.3rem; line-height:1.2; }
        .sidebar-collapse-btn { margin-left:auto; background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.35); color:#fff; width:34px; height:34px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; }
        .sidebar-collapse-btn i { transition: transform .25s ease; }
        body.sidebar-collapsed .sidebar-collapse-btn i { transform:rotate(180deg); }
        .sidebar .menu { list-style:none; margin:0; padding:.5rem .75rem; }
        .sidebar .menu li { margin-bottom:.35rem; }
        .sidebar .menu a { position:relative; display:flex; align-items:center; gap:12px; padding:.65rem .9rem; color:rgba(255,255,255,.95); text-decoration:none; border-radius:12px; transition: background .2s ease, transform .2s ease, color .2s ease; }
        .sidebar .menu a:hover { background:rgba(255,255,255,.10); transform:translateX(3px); }
        .sidebar .menu a.active { background:rgba(255,255,255,.16); box-shadow: inset 0 0 0 1px rgba(255,255,255,.20); }
        .sidebar .menu a.active::before { content:""; position:absolute; left:-6px; top:10px; bottom:10px; width:3px; border-radius:3px; background:#fff; }
        .sidebar .menu a .icon { width:22px; min-width:22px; text-align:center; opacity:.95; }
        .sidebar::-webkit-scrollbar { width:8px; } .sidebar::-webkit-scrollbar-track{ background:rgba(255,255,255,.08); border-radius:8px; } .sidebar::-webkit-scrollbar-thumb{ background:rgba(0,0,0,.25); border-radius:8px; } .sidebar::-webkit-scrollbar-thumb:hover{ background:rgba(0,0,0,.35); }
        .content-wrapper { margin-left:260px; transition: margin-left .25s ease; padding-top:56px; }
        @media (max-width:991.98px){ .sidebar{ transform:translateX(-100%); transition: transform .25s ease; } .sidebar.open{ transform:translateX(0); } .content-wrapper{ margin-left:0; padding-top:56px; } .content-wrapper.shifted{ margin-left:260px; } }
        .sidebar-overlay { position:fixed; inset:0; background:rgba(0,0,0,.25); z-index:1015; display:none; }
        .sidebar-overlay.show { display:block; }
        /* Card styles for Bookings list page */
        .modern-card { background:#fff; border-radius:16px; padding:1.25rem; box-shadow:0 6px 18px rgba(0,0,0,.08); }
        .modern-card .card-title { font-weight:700; margin-bottom:1rem; }
        .chip-header { display:flex; align-items:center; gap:10px; padding:6px 12px; background:#f8f9fc; border:1px solid #e9ecef; border-radius:9999px; flex-wrap:wrap; }
        .chip-header .chip-title { margin:0; font-size:1rem; font-weight:700; display:flex; align-items:center; gap:8px; }
        .chip-header .chip-spacer { flex:1; }
        .rounded-table { border:1px solid #e9ecef; border-radius:12px; overflow:hidden; }
        .rounded-table .table { margin-bottom:0; }
        .rounded-table thead th { background:#f8f9fc; }
        .rounded-table tbody tr:hover { background-color:#f7f9ff; }
        .pill-input { border-radius:9999px !important; padding:.5rem .9rem; }
        .pill-select { border-radius:9999px !important; padding:.45rem .9rem; }
        .pill-btn { border-radius:9999px !important; padding:.45rem 1rem; }
        .hidden { display:none !important; }
        /* Center the filters group within the header using CSS Grid */
        .chip-header { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; }
        .chip-header .chip-title { justify-self: start; }
        .chip-header .filters-center { margin-inline: auto; justify-content: center; justify-self: center; gap: 0.85rem; row-gap: 0.6rem; }
        .chip-header .chip-actions { justify-self: end; }
        .chip-header .chip-spacer { display: none; }
        /* Extra spacing between capsules inside the button group */
        .chip-header .filters-center .btn-group { gap: 0.5rem; }
        /* Keep date input without extra offset (now centered by container) */
        #checkInDate { margin-inline-start: 0; }
    </style>
</head>
<body>
    <!-- Top Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <button class="btn btn-outline-light btn-sm me-2 d-lg-none" type="button" onclick="toggleSidebar()" title="Menu">
                <i class="fas fa-bars"></i>
            </button>
            <div class="search-center d-flex">
                <div class="search-box" style="flex:1">
                    <i class="fas fa-search icon-left"></i>
                    <input id="searchInput" type="text" placeholder="Search bookings..." oninput="debouncedLoad()">
                    <select id="paymentFilter" class="search-select" onchange="loadBookings()">
                        <option value="ALL">Payment: All</option>
                        <option value="paid">Paid</option>
                        <option value="partial">Partial</option>
                        <option value="pending">Pending</option>
                    </select>
                    <i class="fas fa-sliders-h icon-right"></i>
                </div>
            </div>
            <div class="navbar-nav ms-auto align-items-center avatar-menu">
                <div class="dropdown">
                    <button class="btn avatar-btn p-0" type="button" id="avatarDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="Account">
                        <div class="avatar" id="navAvatar">SA</div>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="avatarDropdown">
                        <li><h6 class="dropdown-header" id="avatarUsername">Super Admin</h6></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>Profile</a></li>
                        <li><a class="dropdown-item" href="settings.html"><i class="fas fa-cog me-2"></i>Settings</a></li>
                       
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar" id="appSidebar">
        <div class="sidebar-header">
            <img src="image/logoe.png" alt="Smart Hotel Logo" class="brand-logo">
            <span class="brand-name">Smart Hotel</span>
            <button class="btn sidebar-collapse-btn d-none d-lg-inline-flex" type="button" onclick="toggleSidebarCollapsed()" title="Collapse/Expand">
                <i class="fas fa-angles-left"></i>
            </button>
        </div>
        <ul class="menu">
            <li><a href="dashboard.html"><span class="icon"><i class="fas fa-gauge"></i></span><span class="label">Dashboard</span></a></li>
            <li><a href="rooms.html"><span class="icon"><i class="fas fa-bed"></i></span><span class="label">Rooms</span></a></li>
            <li><a href="bookings.html" class="active"><span class="icon"><i class="fas fa-calendar-check"></i></span><span class="label">Bookings</span></a></li>
            <li><a href="clients.html"><span class="icon"><i class="fas fa-users"></i></span><span class="label">Clients</span></a></li>
            <li><a href="employees.html"><span class="icon"><i class="fas fa-user-tie"></i></span><span class="label">Employees</span></a></li>
            <li><a href="reports.html"><span class="icon"><i class="fas fa-chart-line"></i></span><span class="label">Reports</span></a></li>
            <li><a href="contact.html"><span class="icon"><i class="fas fa-envelope"></i></span><span class="label">Contact</span></a></li>
            <li><a href="settings.html"><span class="icon"><i class="fas fa-cog"></i></span><span class="label">Settings</span></a></li>
        </ul>
    </aside>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Content -->
    <div class="content-wrapper" id="contentWrapper">
        <div class="container mt-4">
            <div class="modern-card">
                <div class="chip-header mb-2">
                    <h5 class="chip-title mb-0"><i class="fas fa-calendar-check"></i><span>Bookings</span></h5>
                    
                    <div class="d-flex align-items-center gap-2 flex-wrap filters-center">
                        <input type="date" id="checkInDate" class="form-control form-control-sm pill-input" onchange="loadBookings()" title="Filter by check-in date">
                        <div class="btn-group" role="group" aria-label="Active/Ended">
                            <button id="btnActive" class="btn btn-sm btn-outline-primary pill-btn" onclick="setActiveOnly(true)"><i class="fa-solid fa-toggle-on me-1"></i>Active</button>
                            <button id="btnEnded" class="btn btn-sm btn-outline-secondary pill-btn" onclick="setEndedOnly(true)"><i class="fa-solid fa-flag-checkered me-1"></i>Ended</button>
                            <button id="btnAll" class="btn btn-sm btn-outline-dark pill-btn" onclick="clearActiveEnded()"><i class="fa-solid fa-list me-1"></i>All</button>
                        </div>
                    </div>
                    
                    <div class="chip-spacer"></div>
                    <div class="chip-actions">
                        <a href="#" class="btn btn-sm btn-danger rounded-pill me-2" onclick="exportBookingsToPDF();return false;"><i class="fas fa-file-pdf me-1"></i> PDF</a>
                        <a href="#" class="btn btn-sm btn-success rounded-pill" onclick="exportBookingsToExcel();return false;"><i class="fas fa-file-excel me-1"></i> Excel</a>
                    </div>
                </div>
                <div class="table-responsive rounded-table">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Client</th>
                                <th>Room</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Guests</th>
                                <th>Status</th>
                                <th>Payment</th>
                                <th>Employee</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTableBody">
                            <tr id="bookingsLoading">
                                <td colspan="10" class="text-center py-4">
                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                    Loading bookings...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Export libs: jsPDF + autoTable, and SheetJS for Excel -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        // Auth check
        checkAuthentication();

        async function checkAuthentication(){
            try{
                const response = await fetch('../backend/check_super_admin_session.php');
                const data = await response.json();
                if(!data.authenticated){ window.location.href='login.html'; return; }
                const username = (data.user && data.user.username) ? String(data.user.username) : 'User';
                const initials = username.split(/\s+|_/).filter(Boolean).slice(0,2).map(w=>w[0]).join('').toUpperCase();
                const avatarEl = document.getElementById('navAvatar');
                if(avatarEl){ avatarEl.textContent = initials || 'U'; avatarEl.title = username; }
                const avatarUsername = document.getElementById('avatarUsername');
                if(avatarUsername) avatarUsername.textContent = username;
            }catch(e){ console.error('Authentication check failed:', e); window.location.href='login.html'; }
        }

        // Sidebar controls
        function toggleSidebar(){
            const sidebar = document.getElementById('appSidebar');
            const content = document.getElementById('contentWrapper');
            const overlay = document.getElementById('sidebarOverlay');
            if(!sidebar||!content) return;
            sidebar.classList.toggle('open');
            content.classList.toggle('shifted');
            if(overlay) overlay.classList.toggle('show');
        }
        function closeSidebar(){
            const sidebar = document.getElementById('appSidebar');
            const content = document.getElementById('contentWrapper');
            const overlay = document.getElementById('sidebarOverlay');
            if(!sidebar||!content) return;
            sidebar.classList.remove('open');
            content.classList.remove('shifted');
            if(overlay) overlay.classList.remove('show');
        }
        function applySidebarCollapsed(collapsed){
            document.body.classList.toggle('sidebar-collapsed', !!collapsed);
            try{ localStorage.setItem('sidebarCollapsed', collapsed ? '1' : '0'); }catch(e){}
        }
        function toggleSidebarCollapsed(){
            const collapsed = !document.body.classList.contains('sidebar-collapsed');
            applySidebarCollapsed(collapsed);
        }
        (function initSidebarCollapsed(){
            try{ const saved = localStorage.getItem('sidebarCollapsed'); if(saved==='1') applySidebarCollapsed(true); }catch(e){}
        })();

        async function logout(){
            if(confirm('Are you sure you want to logout?')){
                try{ await fetch('../backend/super_admin_logout.php', { method:'POST' }); }catch(e){ console.error('Logout error:', e); }
                window.location.href = 'login.html';
            }
        }

        // Filters state
        let activeOnly = false;
        let endedOnly = false;
        let debounceTimer = null;
        function setActiveOnly(v){ activeOnly = !!v; endedOnly = false; highlightActiveButtons(); loadBookings(); }
        function setEndedOnly(v){ endedOnly = !!v; activeOnly = false; highlightActiveButtons(); loadBookings(); }
        function clearActiveEnded(){ activeOnly = false; endedOnly = false; highlightActiveButtons(); loadBookings(); }
        function highlightActiveButtons(){
            document.getElementById('btnActive').classList.toggle('btn-primary', activeOnly);
            document.getElementById('btnActive').classList.toggle('btn-outline-primary', !activeOnly);
            document.getElementById('btnEnded').classList.toggle('btn-secondary', endedOnly);
            document.getElementById('btnEnded').classList.toggle('btn-outline-secondary', !endedOnly);
            const all = !activeOnly && !endedOnly;
            document.getElementById('btnAll').classList.toggle('btn-dark', all);
            document.getElementById('btnAll').classList.toggle('btn-outline-dark', !all);
        }
        function debouncedLoad(){
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(loadBookings, 300);
        }
        // Load bookings
        async function loadBookings(){
            try{
                const tbody = document.getElementById('bookingsTableBody');
                const loadingTpl = document.getElementById('bookingsLoading');
                const headerRow = document.querySelector('.rounded-table thead tr');
                const colCount = headerRow ? headerRow.children.length : 10;
                tbody.innerHTML = loadingTpl
                    ? loadingTpl.outerHTML
                    : `\n<tr id="bookingsLoading">\n  <td colspan="${colCount}" class="text-center py-4">\n    <div class=\"spinner-border spinner-border-sm text-primary me-2\" role=\"status\"></div>\n    Loading bookings...\n  </td>\n</tr>`;
                const params = new URLSearchParams();
                if(activeOnly) params.set('active_only', '1');
                if(endedOnly) params.set('ended_only', '1');
                const checkInDate = document.getElementById('checkInDate').value;
                if(checkInDate) params.set('check_in_date', checkInDate);
                const searchName = document.getElementById('searchInput').value.trim();
                if(searchName) params.set('search_name', searchName);
                const paymentFilter = document.getElementById('paymentFilter').value;
                if(paymentFilter && paymentFilter !== 'ALL') params.set('payment_filter', paymentFilter);

                const res = await fetch('../backend/get_bookings.php' + (params.toString() ? ('?' + params.toString()) : ''));
                const data = await res.json();
                if(!data.success) throw new Error(data.message || 'Failed to load bookings');
                renderBookings(data.data || []);
            }catch(error){
                console.error('Error loading bookings:', error);
                document.getElementById('bookingsTableBody').innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error loading bookings: ${error.message}
                        </td>
                    </tr>`;
            }
        }

        function renderBookings(rows){
            const tbody = document.getElementById('bookingsTableBody');
            if(!rows || rows.length === 0){
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-4 text-muted">
                            <i class="fas fa-calendar-xmark fa-2x mb-2"></i><br>
                            No bookings found
                        </td>
                    </tr>`;
                return;
            }
            tbody.innerHTML = '';
            rows.forEach(b => {
                const fullName = `${(b.first_name||'').trim()} ${(b.last_name||'').trim()}`.trim() || 'Unknown';
                tbody.innerHTML += `
                    <tr>
                        <td>${b.id}</td>
                        <td>${fullName}</td>
                        <td>${b.room_number ?? ''}</td>
                        <td>${formatDT(b.check_in)}</td>
                        <td>${formatDT(b.check_out)}</td>
                        <td>${b.number_of_guests ?? ''}</td>
                        <td>${getStatusBadge(b.status)}</td>
                        <td>${getPaymentBadge(b.payment_status)}</td>
                        <td>${b.employee_id ? `<a href="employees.html?highlightEmployeeId=${b.employee_id}" class="text-decoration-none">${b.employee_id}</a>` : ''}</td>
                        <td>${formatCurrency(b.total_amount)}</td>
                    </tr>`;
            });
        }

        function getStatusBadge(status){
            const s = (status||'').toLowerCase();
            if(s === 'reserved' || s === 'checked_in') return '<span class="badge bg-success">Active</span>';
            if(s === 'checked_out') return '<span class="badge bg-secondary">Ended</span>';
            if(s === 'cancelled') return '<span class="badge bg-danger">Cancelled</span>';
            return '<span class="badge bg-info text-dark">Unknown</span>';
        }
        function getPaymentBadge(payment){
            const p = (payment||'').toLowerCase();
            if(p === 'paid') return '<span class="badge bg-primary">Paid</span>';
            if(p === 'partial') return '<span class="badge bg-warning text-dark">Partial</span>';
            if(p === 'pending') return '<span class="badge bg-secondary">Pending</span>';
            return '<span class="badge bg-light text-dark">N/A</span>';
        }
        function formatDT(dt){
            try{
                if(!dt) return '';
                // Expecting 'YYYY-MM-DD HH:MM:SS' or similar
                const d = new Date(dt.replace(' ', 'T'));
                if(isNaN(d)) return dt;
                return d.toLocaleString();
            }catch(e){ return dt; }
        }
        function formatCurrency(v){
            const num = Number(v);
            if(Number.isFinite(num)) return num.toLocaleString(undefined, { style:'currency', currency:'MAD', currencyDisplay:'narrowSymbol', maximumFractionDigits:2 });
            return v ?? '';
        }

        // Export helpers
        function exportBookingsToPDF(){
            try{
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'pt');
                doc.text('Smart Hotel - Bookings', 40, 40);
                const rows = Array.from(document.querySelectorAll('#bookingsTableBody tr')).map(tr => {
                    const tds = tr.querySelectorAll('td');
                    if(!tds || tds.length < 10) return null;
                    return [tds[0].innerText, tds[1].innerText, tds[2].innerText, tds[3].innerText, tds[4].innerText, tds[5].innerText, tds[6].innerText, tds[7].innerText, tds[8].innerText, tds[9].innerText];
                }).filter(Boolean);
                doc.autoTable({
                    head: [['ID','Client','Room','Check-in','Check-out','Guests','Status','Payment','Employee ID','Total']],
                    body: rows,
                    startY: 60,
                    styles: { font: 'helvetica', fontStyle: 'normal' },
                });
                doc.save('bookings.pdf');
            }catch(e){ alert('Export to PDF failed: ' + e.message); }
        }
        function exportBookingsToExcel(){
            try{
                const wb = XLSX.utils.book_new();
                const data = [['ID','Client','Room','Check-in','Check-out','Guests','Status','Payment','Employee ID','Total']];
                Array.from(document.querySelectorAll('#bookingsTableBody tr')).forEach(tr => {
                    const tds = tr.querySelectorAll('td');
                    if(!tds || tds.length < 10) return;
                    data.push([tds[0].innerText, tds[1].innerText, tds[2].innerText, tds[3].innerText, tds[4].innerText, tds[5].innerText, tds[6].innerText, tds[7].innerText, tds[8].innerText, tds[9].innerText]);
                });
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, 'Bookings');
                XLSX.writeFile(wb, 'bookings.xlsx');
            }catch(e){ alert('Export to Excel failed: ' + e.message); }
        }

        function escapeHTML(s){
            return String(s).replace(/[&<>"]+/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            highlightActiveButtons();
            loadBookings();
        });
    </script>
</body>
</html>
